# Auditor√≠a de Base de Datos y L√≥gica de C√°lculo

## 1. Introducci√≥n
**Objetivo**: Identificar inconsistencias, cuellos de botella y errores en el motor de c√°lculo y la estructura de datos del sistema "Modo Ahorro".

## 2. Inventario de Componentes Detectados

### a) Servicios de C√°lculo
El motor de c√°lculo parece estar distribuido en varios servicios:
- **SolarWaterHeaterService**: Calcula viabilidad de termotanques solares. Depende de `ClimateDataService` y `SolarWaterService`.
- **GridOptimizerService**: Calcula ahorros por desplazamiento de cargas. Depende de `TariffScheme`.
- **ConsumptionAnalysisService**: (Pendiente de revisi√≥n) Probablemente centraliza el an√°lisis de hist√≥rico de facturas.
- **ConsumptionCalibrator**: (Pendiente de revisi√≥n) Ajuste de consumos.

### b) Estructura de Base de Datos (Clave para c√°lculos)
Tablas principales identificadas en migraciones:
- `invoices`: Datos hist√≥ricos de facturaci√≥n.
- `equipment_usages`: Perfiles de uso de equipos.
- `tariff_schemes`: Esquemas tarifarios para costos de energ√≠a.
- `climate_data`: Datos clim√°ticos para c√°lculos t√©rmicos/solares.
- `efficiency_benchmarks`: Comparativas de eficiencia.

## 3. Puntos de Auditor√≠a Prouestos

### A. Validaci√≥n de Datos (Base de Datos)
1.  **Integridad de `invoices`**: Verificar duplicados, saltos en fechas, y consistencia de `total_energy_consumed_kwh` vs importes.
2.  **Integridad de `equipment_usages`**: Verificar que `daily_kwh` y `kwh_reconciled` sean consistentes.
3.  **Tarifas**: Verificar que `TariffScheme` tenga bandas horarias correctamente definidas y sin superposiciones inv√°lidas.

### B. Revisi√≥n de L√≥gica (C√≥digo)
1.  **Manejo de Nulos**: Revisar c√≥mo los servicios manejan datos faltantes (ej. `GridOptimizerService` tiene un fallback `daily_kwh * 30` si `kwh_reconciled` es nulo).
2.  **Hardcoded Values**: Detectar valores fijos ocultos (ej. `$averageTariff = 150` en `SolarWaterHeaterService`).
3.  **Precisi√≥n**: Verificar f√≥rmulas de ahorro y proyecciones.

## 4. Hallazgos de la Auditor√≠a

### A. Arquitectura del Motor de C√°lculo

El sistema implementa un **Motor Integral de Calibraci√≥n en 3 Fases**:

#### **Fase 1: Entrada de Usuario** (`UsageAdjustmentController`)
- El usuario define patrones de uso por equipo:
  - Frecuencia: diario, semanal, quincenal, mensual, puntual
  - D√≠as de la semana (para diario/semanal)
  - Horas promedio de uso diario
  - Cantidad de usos (para frecuencias puntuales)
  - Duraci√≥n promedio por uso

#### **Fase 2: C√°lculo Te√≥rico** (`ConsumptionAnalysisService`)
F√≥rmula base: `Energ√≠a (kWh) = P √ó h √ó d √ó FC`

Donde:
- **P** = Potencia nominal (kW) - de la etiqueta del equipo
- **h** = Horas de uso promedio diario
- **d** = D√≠as efectivos en el per√≠odo
- **FC** = Factor de carga real (`load_factor`)

**Ajustes aplicados:**
1. **Ajuste Clim√°tico para Climatizaci√≥n** (l√≠neas 124-194):
   - Aires acondicionados: Solo cuentan d√≠as con temp ‚â•28¬∞C
   - Calefacci√≥n: Solo cuentan d√≠as con temp <15¬∞C
   - Datos obtenidos de Open-Meteo API (hist√≥ricos gratuitos)

2. **Ajuste Clim√°tico para Termotanques** (l√≠neas 210-244):
   - Invierno (temp <15¬∞C): Factor x1.25 (agua m√°s fr√≠a)
   - Verano (temp >25¬∞C): Factor x0.85 (agua m√°s tibia)

3. **Ajuste por Mantenimiento** (l√≠neas 78-79, 107-108):
   - Penalizaci√≥n si hay tareas de mantenimiento vencidas
   - Implementado en `MaintenanceService`

4. **Consumo Vampiro/Standby** (l√≠neas 82-95):
   - Calculado para horas que el equipo NO est√° en uso activo
   - Usa `default_standby_power_w` del tipo de equipo

#### **Fase 3: Calibraci√≥n Jer√°rquica** (`ConsumptionCalibrator`)
Distribuye el consumo total de la factura seg√∫n **prioridades**:

```
1. Base Cr√≠tica (Heladeras, Routers, Alarmas)
   ‚Üí Se asigna el 100% de su consumo estimado SIEMPRE
   
2. Hormigas (Iluminaci√≥n, Cargadores)
   ‚Üí Se asigna el 100% de su consumo estimado
   
3. Base Pesada (Termotanques, Bombas)
   ‚Üí Se asigna lo estimado si hay margen
   
4. Ballenas (Aires, Estufas, PC Gamer, TV)
   ‚Üí ABSORBEN LA VARIABILIDAD
   ‚Üí Ajuste proporcional con el remanente
```

**L√≥gica de distribuci√≥n** (l√≠neas 39-93):
- Si `remaining >= required`: Asignaci√≥n completa
- Si `remaining < required`: Asignaci√≥n proporcional
- Si sobra energ√≠a sin ballenas: Redistribuci√≥n proporcional

### B. Problemas Identificados

#### üî¥ **CR√çTICO 1: Clasificaci√≥n por String Matching**
**Ubicaci√≥n:** `ConsumptionCalibrator.php` l√≠neas 96-119 y `UsageAdjustmentController.php` l√≠neas 96-123

**Problema:**
```php
if (str_contains($combined, 'heladera') || str_contains($combined, 'freezer') || ...)
```

- La categorizaci√≥n depende de **palabras clave en el nombre** del equipo
- **Fr√°gil**: Un equipo llamado "Heladera Samsung" se clasifica correctamente, pero "Refrigerador Samsung" cae en "otros"
- **Duplicaci√≥n de c√≥digo**: La misma l√≥gica existe en 2 lugares (violaci√≥n DRY)
- **No escalable**: Agregar nuevas categor√≠as requiere modificar c√≥digo

**Impacto:**
- Equipos mal clasificados pueden absorber variabilidad cuando deber√≠an ser intocables
- Inconsistencias entre lo que muestra la UI y lo que calcula el calibrador

#### üî¥ **CR√çTICO 2: Falta de Validaci√≥n de Coherencia**
**Problema:** No hay validaci√≥n que verifique que la suma de consumos estimados sea **razonable** antes de calibrar.

**Escenarios problem√°ticos:**
1. Usuario declara que un foco LED de 4W funciona 24h/d√≠a durante 30 d√≠as
   - Consumo estimado: 2.88 kWh/mes ‚úÖ (razonable)
   
2. Usuario declara que un aire de 2000W funciona 24h/d√≠a durante 30 d√≠as
   - Consumo estimado: 1440 kWh/mes ‚ùå (probablemente error)
   - Si la factura dice 300 kWh, el calibrador **forzar√°** el aire a 1440 kWh y dejar√° todo lo dem√°s en 0

**Falta:**
- Validaci√≥n de l√≠mites m√°ximos por categor√≠a
- Alertas cuando un equipo "Hormiga" consume m√°s que una "Ballena"
- Detecci√≥n de outliers antes de calibrar

#### üü† **ALTO 3: Dependencia Absoluta de Datos Clim√°ticos**
**Ubicaci√≥n:** `ConsumptionAnalysisService.php` l√≠neas 124-194

**Problema:**
```php
if ($category !== 'Climatizaci√≥n') {
    return $totalDays; // Sin ajuste
}
// Para climatizaci√≥n, REQUIERE datos clim√°ticos
$effectiveDays = $stats['hot_days_count'] ?? 0;
return max(0, $effectiveDays);
```

**Escenarios problem√°ticos:**
1. Localidad sin coordenadas ‚Üí Aire acondicionado usa `$totalDays` (sin ajuste)
2. API de Open-Meteo ca√≠da ‚Üí Fallback a `$totalDays`
3. Per√≠odo futuro (no hay hist√≥ricos) ‚Üí Sin datos

**Impacto:**
- Inconsistencia: Mismo equipo, mismo per√≠odo, diferentes resultados seg√∫n disponibilidad de API
- Si la API falla, los aires pueden sobre-estimarse significativamente

#### üü† **ALTO 4: Consumo Standby Siempre Activo**
**Ubicaci√≥n:** `ConsumptionAnalysisService.php` l√≠neas 82-95

**Problema:**
```php
if ($usage->equipment->is_standby) {
    $standbyHoursPerDay = max(0, 24 - $hoursPerDay);
    $standbyConsumption = $standbyPowerKw * $standbyHoursPerDay * $daysInPeriod;
    $consumption += $standbyConsumption;
}
```

**Escenario problem√°tico:**
- Un TV que el usuario dice usar 2h/d√≠a
- Standby: 5W
- Per√≠odo: 30 d√≠as
- **Consumo standby = 0.005 kW √ó 22h √ó 30 = 3.3 kWh**
- Pero si el usuario desenchufa el TV cuando no lo usa, este c√°lculo es **incorrecto**

**Falta:**
- Opci√≥n para que el usuario indique si desenchufa el equipo
- Diferenciaci√≥n entre "apagado pero enchufado" vs "desenchufado"

#### üü° **MEDIO 5: Hardcoded Thresholds**
**Ubicaci√≥n:** M√∫ltiples archivos

**Ejemplos:**
```php
// ConsumptionAnalysisService.php l√≠nea 158
if (str_contains($equipmentName, 'aire') || ...) {
    $effectiveDays = $stats['hot_days_count'] ?? 0; // Umbral: 28¬∞C (hardcoded en ClimateDataService)
}

// ConsumptionAnalysisService.php l√≠nea 229
if ($avgTemp < 15) { // Hardcoded
    return 1.25;
}

// SolarWaterHeaterService.php l√≠nea 58
$averageTariff = 150; // Default fallback hardcoded
```

**Problema:**
- Umbrales no configurables por regi√≥n
- 28¬∞C puede ser razonable para Buenos Aires, pero no para Ushuaia
- No hay forma de ajustar sin modificar c√≥digo

#### üü° **MEDIO 6: Falta de Logging Estructurado**
**Problema:** Los logs existen pero son inconsistentes:
```php
\Log::info("üå°Ô∏è AIRE: {$usage->equipment->name} - D√≠as: {$totalDays} ‚Üí {$effectiveDays}");
```

**Falta:**
- Log de la **decisi√≥n de calibraci√≥n** (por qu√© se ajust√≥ X equipo)
- Trazabilidad: ¬øQu√© factores afectaron el c√°lculo final?
- Historial de ajustes para debugging

#### üü¢ **BAJO 7: Eficiencia de Consultas**
**Ubicaci√≥n:** `UsageAdjustmentController.php` l√≠neas 61-74

**Problema potencial:**
```php
$rooms = $entity->rooms()->with(['equipment' => function($q) use ($invoice) {
    // Consulta compleja con m√∫ltiples condiciones
}])->get();
```

- Para entidades con muchas habitaciones y equipos, puede ser lento
- No hay paginaci√≥n ni l√≠mites

### C. Fortalezas del Sistema

‚úÖ **Arquitectura bien pensada**: Separaci√≥n clara entre entrada, c√°lculo y calibraci√≥n
‚úÖ **Integraci√≥n clim√°tica**: Uso de API gratuita (Open-Meteo) con cach√© en BD
‚úÖ **Jerarqu√≠a de prioridades**: Concepto de Base Cr√≠tica ‚Üí Hormigas ‚Üí Pesada ‚Üí Ballenas es s√≥lido
‚úÖ **Ajustes contextuales**: Termotanques con factor estacional es un buen detalle
‚úÖ **Consumo vampiro**: Consideraci√≥n del standby es importante

### D. Recomendaciones Prioritarias

#### üéØ **Prioridad 1: Refactorizar Clasificaci√≥n de Equipos**
**Acci√≥n:**
1. Agregar campo `tier` a la tabla `equipment_types` (enum: 'base_critica', 'base_pesada', 'hormigas', 'ballenas', 'otros')
2. Migrar l√≥gica de string matching a configuraci√≥n de base de datos
3. Crear interfaz para que el usuario pueda **reclasificar** equipos manualmente

**Beneficio:**
- Elimina fragilidad
- Permite personalizaci√≥n por usuario
- Centraliza la l√≥gica

#### üéØ **Prioridad 2: Implementar Validaci√≥n Pre-Calibraci√≥n**
**Acci√≥n:**
1. Calcular l√≠mites te√≥ricos por categor√≠a:
   ```
   Hormigas: Max 5% del total de la factura
   Base Cr√≠tica: Max 30% del total
   Base Pesada: Max 40% del total
   Ballenas: Resto
   ```
2. Alertar al usuario si los valores declarados exceden l√≠mites
3. Sugerir ajustes autom√°ticos

**Beneficio:**
- Previene errores de entrada
- Mejora la precisi√≥n del calibrador

#### üéØ **Prioridad 3: Hacer Configurables los Umbrales Clim√°ticos**
**Acci√≥n:**
1. Agregar tabla `climate_thresholds` con campos:
   - `locality_id` (o `province_id` para regionalizaci√≥n)
   - `hot_threshold` (default: 28¬∞C)
   - `cold_threshold` (default: 15¬∞C)
   - `water_heater_winter_factor` (default: 1.25)
   - `water_heater_summer_factor` (default: 0.85)

**Beneficio:**
- Adaptabilidad regional
- Mejora precisi√≥n en diferentes climas

#### üéØ **Prioridad 4: Mejorar Manejo de Standby**
**Acci√≥n:**
1. Agregar campo `is_unplugged_when_off` a `equipment_usages`
2. Solo calcular standby si `is_unplugged_when_off = false`

**Beneficio:**
- Mayor precisi√≥n para usuarios conscientes del consumo vampiro

#### üéØ **Prioridad 5: Implementar Audit Trail**
**Acci√≥n:**
1. Crear tabla `calibration_logs`:
   ```sql
   - invoice_id
   - equipment_id
   - kwh_estimated
   - kwh_reconciled
   - tier
   - calibration_note
   - climate_factor_applied
   - maintenance_penalty_applied
   - timestamp
   ```
2. Registrar cada decisi√≥n del calibrador

**Beneficio:**
- Debugging facilitado
- Transparencia para el usuario
- An√°lisis de patrones

### E. Diagrama de Flujo del Motor Actual

```mermaid
graph TD
    A[Usuario ingresa patrones de uso] --> B[Fase 1: Guardar en equipment_usages]
    B --> C[Fase 2: Calcular consumo te√≥rico]
    C --> D{¬øEs climatizaci√≥n?}
    D -->|S√≠| E[Consultar ClimateDataService]
    E --> F[Ajustar d√≠as efectivos seg√∫n clima]
    D -->|No| G[Usar d√≠as totales del per√≠odo]
    F --> H[Aplicar f√≥rmula: P √ó h √ó d √ó FC]
    G --> H
    H --> I{¬øEs termotanque?}
    I -->|S√≠| J[Aplicar factor estacional]
    I -->|No| K[Continuar]
    J --> K
    K --> L{¬øTiene mantenimiento vencido?}
    L -->|S√≠| M[Aplicar penalizaci√≥n]
    L -->|No| N[Continuar]
    M --> N
    N --> O{¬øTiene standby?}
    O -->|S√≠| P[Sumar consumo vampiro]
    O -->|No| Q[kwh_estimated listo]
    P --> Q
    Q --> R[Fase 3: Calibraci√≥n jer√°rquica]
    R --> S[Clasificar por tier]
    S --> T[Asignar Base Cr√≠tica 100%]
    T --> U[Asignar Hormigas 100%]
    U --> V[Asignar Base Pesada seg√∫n margen]
    V --> W[Ballenas absorben remanente]
    W --> X[kwh_reconciled final]
```

## 5. Conclusi√≥n

El motor de c√°lculo tiene una **arquitectura s√≥lida** con conceptos bien fundamentados (jerarqu√≠a de prioridades, ajuste clim√°tico, consumo vampiro). Sin embargo, presenta **fragilidades cr√≠ticas** en:

1. **Clasificaci√≥n de equipos** (string matching fr√°gil)
2. **Validaci√≥n de entrada** (permite valores incoherentes)
3. **Configurabilidad** (umbrales hardcoded)

Las recomendaciones propuestas son **implementables** y mejorar√≠an significativamente la **precisi√≥n** y **robustez** del sistema sin requerir una reescritura completa.

**Pr√≥ximos pasos sugeridos:**
1. Implementar Prioridad 1 (refactorizar clasificaci√≥n)
2. Agregar validaciones pre-calibraci√≥n (Prioridad 2)
3. Crear suite de tests unitarios para el calibrador
4. Documentar casos de uso y l√≠mites del sistema

